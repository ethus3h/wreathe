#!/bin/bash
#Ember Offline Git UPdater
set -e
rubberfs save || error-notify "ERROR running rubberfs save!"
set +e
(
    set -e
    cd /Ember\ Library || error-notify "Could not open Ember Library directory!"
    set -e
    (
        cd Ember\ satellite\ projects/wreathe-bootstrap/usr/local/portage || error-notify "Could not open wreathe-bootstrap directory!"
        set +e
        repoman manifest
        set -e
    )
    (
        cd Ember\ satellite\ projects/wreathe-overlay || error-notify "Could not open wreathe-overlay directory!"
        set +e
        repoman manifest
        set -e
    )
    set +e
    findemberlibraryfolders() {
        find . -maxdepth 1 -not -name '\.*' -name "ember-library-[0-9]" -type d -print0 | xargs -i{} -0 -P 3 sh -c 'eogup-single "$1"' -- '{}' \;
    }
    findemberfolders() {
        find . -maxdepth 1 -not -name '\.*' -type d -print0 | xargs -i{} -0 -P 15 sh -c 'eogup-single "$1"' -- '{}' \;
    }
    set -e
    (
        cd Ember || error-notify "Could not open Ember directory!"
        (
            cd ember-library || error-notify "Could not open Ember library directory!"
            findemberlibraryfolders || error-notify "ERROR running Ember library folders update!"
        )
        findemberfolders || error-notify "ERROR running Ember folders update!"
    )
    (
        cd Ember\ satellite\ projects || error-notify "Could not open Ember satellite projects directory!"
        findemberfolders || error-notify "ERROR running satellite projects update!"
    )
    eogup-single Ember
    eogup-single Ember\ satellite\ projects/wreathe-overlays-redist || warn "Note: failed updating redistributed overlays; this is normal if you only have a partial clone of the Ember tree"
    eogup-single Ember\ satellite\ projects || warn "Note: failed updating satellite projects meta-repository; this is normal if you only have a partial clone of the Ember tree"
)
eogup-single /Ember\ Library || warn "Note: failed updating Ember meta-repository; this is normal if you only have a partial clone of the Ember tree"
printf "\033c"
echo "Done updating."
