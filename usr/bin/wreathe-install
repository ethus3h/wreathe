#!/usr/bin/env bash
# shellcheck disable=SC1091
#set -x

die() {
    printf %b '\033[1;31m' "$(ps -o args= $PPID)" '\nfailed with the error on '"${BASH_SOURCE[0]} line ${LINENO}"':\n' "${@+$@$'\n'}" '\033[0m' >&2
    save_traps="$(trap)"
    save_traps="${save_traps//error-notify/true}"
    trap 'eval "$save_traps"; false; exit 1' ERR
    exit 1
}

((EUID)) && exec sudo -- "$0" "$@"
trap 'die "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO}."' ERR

echo "An account with the nonprofit Internet Archive is needed for installing Wreathe."
sleep 1
echo "If you do not already have one, please press Ctrl+C to exit this installer, and open https://archive.org/account/login.createaccount.php in a Web browser to create one."
sleep 1
echo "You should log in now. (Continuing in 3 seconds.)"
sleep 3
ia configure

echo "What is the path to use as the system (root) partition?"
read sysPartition

echo "What is the path to use as the boot partition?"
read bootPartition

echo "What is the path to the EFI partition?"
read efiPartition

echo "What is the path to use as the swap partition?"
read swapPartition

echo "What is the path to use for temporary storage?"
read tempStorage

identifier="$(wget -O - http://futuramerlin.com/ancillary/wreathe/7.3/identifier.php)"

cd "$tempStorage"

echo "(Beginning downloading Wreathe. This will probably take a while.)"
ia download "$identifier"

echo "(Beginning copying system partition. This will probably take a while.)"
dd if=sys.dd of="${sysPartition:?}"

echo "(Beginning copying boot partition.)"
dd if=boot.dd of="${bootPartition:?}"

mkdir -p install
mount "$sysPartition" install

# TODO: Fix up /etc/fstab

mkdir -p install/boot
mount "$bootPartition" boot

mkdir -p install/boot/efi
mount "$efiPartition" boot/efi

mkdir -p install/boot/grub

grub-install --target=x86_64-efi --efi-directory=boot/efi
grub-mkconfig -o boot/grub/grub.cfg

umount boot/efi
umount boot
umount mountpoint

echo "Done."
