#!/bin/bash
#Ember Git UPdater for single repository
cd "$1" || exit 1

egup-env

branch="$(git branch | grep -E "^\* " | cut -c 3-)"
git checkout "$branch"
set -e
git add -A || error-notify "ERROR adding changes."
git add -A . || error-notify "ERROR adding changes."
set +e
git commit -a -m "Update Ember tree"
set -e
if [ -f .egup.hooks ]; then
    echo "Beginning running hooks..."
    ./.egup.hooks || warn "WARNING! pre-build-hooks failed; continuing anyway."
    echo "Done running hooks."
    set +e
    git commit -a -m "Update Ember tree"
    set -e
fi
set +e
echo "(Updating Git tags file.)"
mv -f .egup.tags .egup.tags.old
git show-ref -d --tags > .egup.tags || mv -fv .egup.tags.old .egup.tags
rm -f .egup.tags.old
set -e
echo "(Done updating Git tags file.)"
git add -A || error-notify "ERROR adding tag changes."
set +e
git commit -a -m "Update Ember tree"
set -e
git pull --all || error-notify "ERROR pulling."
git submodule update --remote || warn "ERROR updating submodules. Maybe a remote server is down?"
if ! [ -f .egup.nopush ]; then
    git push --verbose --tags -u origin master || error-notify "ERROR pushing changes."
    git push --verbose --all -u origin || error-notify "ERROR pushing changes."
fi

egup-exit
