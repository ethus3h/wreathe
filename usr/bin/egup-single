#!/usr/bin/env bash
#Ember Git UPdater for single repository
# shellcheck disable=SC1091
source ember_bash_setup &> /dev/null

trap 'die "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO}."' ERR
# set -x

if [[ "$1" == "--offline" ]]; then
    offline="true"
    shift
fi

cd "$1" || exit 1

egup-env

branch="$(git branch | grep -E "^\* " | cut -c 3-)"
git checkout "$branch"
git add -A || die "Error adding changes."
git add -A . || die "Error adding changes."
git commit -a -m "Update Ember tree" || echo "(Note: Repository appears to have no changes to commit.)"
if [[ -f .egup.hooks ]]; then
    echo "Beginning running hooks..."
    ./.egup.hooks || warn "WARNING! pre-build-hooks failed; continuing anyway."
    echo "Done running hooks."
    git commit -a -m "Update Ember tree" || true #It's ok if this fails â€” it probably means there is nothing to commit, and the user was already notified by saying "no changes to commit" earlier.
fi
git branch --list -a -v > .egup.branches
sed -i '/\* master /d' .egup.branches
sed -i '/remotes\/origin\/master /d' .egup.branches
git show-ref -d > .egup.refs
sed -i '/refs\/heads\/master /d' .egup.branches
sed -i '/refs\/remotes\/origin\/HEAD /d' .egup.branches
sed -i '/refs\/remotes\/origin\/master /d' .egup.branches
git show-ref -d --tags > .egup.tags || echo "(Note: Repository appears to have no tags.)"
git add -A || die "Error adding tag changes."
trap - ERR
git commit -a -m "Update Ember tree" || true
trap 'die "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO}."' ERR

if [[ "$offline" != "true" ]]; then
    git pull --all || die "Error pulling."
    git submodule update --remote || warn "Error updating submodules. Maybe a remote server is down?"
    if ! [[ -f .egup.nopush ]]; then
        git push --verbose --tags -u origin master || die "Error pushing changes."
        git push --verbose --all -u origin || die "Error pushing changes."
    fi
fi

egup-exit
