(function() {
  var CompositeDisposable, ZipFolderView;

  ZipFolderView = require('./zip-folder-view');

  CompositeDisposable = require('atom').CompositeDisposable;

  module.exports = {
    config: {
      compressionLevel: {
        type: 'integer',
        "default": 6,
        description: 'Valid values are 0 (off) - 9 (maximum compression), any other values will result in compression being disabled.'
      }
    },
    modalPanel: null,
    zipFolderView: null,
    subscriptions: null,
    activate: function(state) {
      this.zipFolderView = new ZipFolderView(state.zipFolderViewState);
      this.modalPanel = atom.workspace.addModalPanel({
        item: this.zipFolderView.getElement(),
        visible: false
      });
      this.subscriptions = new CompositeDisposable;
      return this.subscriptions.add(atom.commands.add('atom-workspace', {
        'zip-folder:run': (function(_this) {
          return function() {
            return _this.run();
          };
        })(this)
      }));
    },
    deactivate: function() {
      this.modalPanel.destroy();
      this.subscriptions.dispose();
      return this.zipFolderView.destroy();
    },
    serialize: function() {
      return {
        zipFolderViewState: this.zipFolderView.serialize()
      };
    },
    run: function() {
      var JSZip, absPath, basePaths, basePathsChecked, compressionLevel, content, d, fileCount, files, fs, listTree, name, path, pieces, relPath, savePath, selPath, selected, selectedBasePath, targetPath, zip;
      fs = require('fs-plus');
      JSZip = require("jszip");
      path = require('path');
      zip = new JSZip();
      basePaths = atom.project.getPaths();
      listTree = document.querySelector('.tree-view');
      selected = listTree.querySelectorAll('.selected > .header > span, .selected > span');
      if (selected.length > 1) {
        pieces = basePaths[0].split(path.sep);
        name = pieces[pieces.length - 1].replace(".", "-");
        savePath = basePaths[0] + path.sep + name + ".zip";
        selectedBasePath = "";
      } else {
        pieces = selected[0].dataset.path.split(path.sep);
        name = pieces[pieces.length - 1].replace(".", "-");
        pieces.splice(pieces.length - 1, 1);
        targetPath = pieces.join(path.sep);
        savePath = targetPath + path.sep + name + ".zip";
        selectedBasePath = "";
        if (fs.isDirectorySync(selected[0].dataset.path)) {
          selectedBasePath = selected[0].dataset.path;
        }
      }
      if (fs.existsSync(savePath)) {
        fs.truncateSync(savePath, 0);
      }
      d = 0;
      while (d < selected.length) {
        selPath = selected[d].dataset.path;
        relPath = "";
        files = [];
        if (fs.isDirectorySync(selPath)) {
          files = fs.listTreeSync(selPath);
        } else {
          files = [selPath];
        }
        fileCount = 0;
        while (fileCount < files.length) {
          absPath = files[fileCount];
          if (selectedBasePath !== "") {
            relPath = absPath.replace(selectedBasePath + path.sep, "", 'i');
          } else {
            basePathsChecked = 0;
            while (basePathsChecked < basePaths.length) {
              relPath = absPath.replace(basePaths[basePathsChecked] + path.sep, "", 'i');
              basePathsChecked++;
            }
          }
          if (!fs.isDirectorySync(absPath)) {
            zip.file(relPath, fs.readFileSync(absPath), {
              createFolders: true
            });
          }
          fileCount++;
        }
        d++;
      }
      compressionLevel = atom.config.get('zip-folder.compressionLevel');
      if (compressionLevel === parseInt(compressionLevel, 10) && compressionLevel > 0 && compressionLevel < 10) {
        content = zip.generate({
          type: "nodebuffer",
          compression: "DEFLATE",
          compressionOptions: {
            level: compressionLevel
          }
        });
      } else {
        content = zip.generate({
          type: "nodebuffer"
        });
      }
      return fs.writeFile(savePath, content, function(e) {
        if (e !== null) {
          return atom.notifications.addError(e.message);
        } else {
          return atom.notifications.addSuccess("Zip complete");
        }
      });
    }
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiL2xpYnJhcnkvRW1iZXIgc2F0ZWxsaXRlIHByb2plY3RzL3dyZWF0aGUvdXNyL3NoYXJlL2F0b20vcGFja2FnZXMvemlwLWZvbGRlci9saWIvemlwLWZvbGRlci5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFBQSxNQUFBOztFQUFBLGFBQUEsR0FBZ0IsT0FBQSxDQUFRLG1CQUFSOztFQUNmLHNCQUF1QixPQUFBLENBQVEsTUFBUjs7RUFFeEIsTUFBTSxDQUFDLE9BQVAsR0FDSTtJQUFBLE1BQUEsRUFDSTtNQUFBLGdCQUFBLEVBQ0k7UUFBQSxJQUFBLEVBQU0sU0FBTjtRQUNBLENBQUEsT0FBQSxDQUFBLEVBQVMsQ0FEVDtRQUVBLFdBQUEsRUFBYSxpSEFGYjtPQURKO0tBREo7SUFNRSxVQUFBLEVBQVksSUFOZDtJQU9FLGFBQUEsRUFBZSxJQVBqQjtJQVFFLGFBQUEsRUFBZSxJQVJqQjtJQVVFLFFBQUEsRUFBVSxTQUFDLEtBQUQ7TUFDUixJQUFDLENBQUEsYUFBRCxHQUFxQixJQUFBLGFBQUEsQ0FBYyxLQUFLLENBQUMsa0JBQXBCO01BQ3JCLElBQUMsQ0FBQSxVQUFELEdBQWMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFmLENBQTZCO1FBQUEsSUFBQSxFQUFNLElBQUMsQ0FBQSxhQUFhLENBQUMsVUFBZixDQUFBLENBQU47UUFBbUMsT0FBQSxFQUFTLEtBQTVDO09BQTdCO01BR2QsSUFBQyxDQUFBLGFBQUQsR0FBaUIsSUFBSTthQUdyQixJQUFDLENBQUEsYUFBYSxDQUFDLEdBQWYsQ0FBbUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFkLENBQWtCLGdCQUFsQixFQUFvQztRQUFBLGdCQUFBLEVBQWtCLENBQUEsU0FBQSxLQUFBO2lCQUFBLFNBQUE7bUJBQUcsS0FBQyxDQUFBLEdBQUQsQ0FBQTtVQUFIO1FBQUEsQ0FBQSxDQUFBLENBQUEsSUFBQSxDQUFsQjtPQUFwQyxDQUFuQjtJ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QUQ7UUFDNUIsSUFBRyxDQUFBLEtBQUssSUFBUjtpQkFFSSxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQW5CLENBQTRCLENBQUMsQ0FBQyxPQUE5QixFQUZKO1NBQUEsTUFBQTtpQkFLSSxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQW5CLENBQThCLGNBQTlCLEVBTEo7O01BRDRCLENBQWhDO0lBckhHLENBN0JQOztBQUpKIiwic291cmNlc0NvbnRlbnQiOlsiWmlwRm9sZGVyVmlldyA9IHJlcXVpcmUgJy4vemlwLWZvbGRlci12aWV3J1xue0NvbXBvc2l0ZURpc3Bvc2FibGV9ID0gcmVxdWlyZSAnYXRvbSdcblxubW9kdWxlLmV4cG9ydHMgPVxuICAgIGNvbmZpZzpcbiAgICAgICAgY29tcHJlc3Npb25MZXZlbDpcbiAgICAgICAgICAgIHR5cGU6ICdpbnRlZ2VyJ1xuICAgICAgICAgICAgZGVmYXVsdDogNlxuICAgICAgICAgICAgZGVzY3JpcHRpb246ICdWYWxpZCB2YWx1ZXMgYXJlIDAgKG9mZikgLSA5IChtYXhpbXVtIGNvbXByZXNzaW9uKSwgYW55IG90aGVyIHZhbHVlcyB3aWxsIHJlc3VsdCBpbiBjb21wcmVzc2lvbiBiZWluZyBkaXNhYmxlZC4nXG5cbiAgICAgIG1vZGFsUGFuZWw6IG51bGxcbiAgICAgIHppcEZvbGRlclZpZXc6IG51bGxcbiAgICAgIHN1YnNjcmlwdGlvbnM6IG51bGxcblxuICAgICAgYWN0aXZhdGU6IChzdGF0ZSkgLT5cbiAgICAgICAgQHppcEZvbGRlclZpZXcgPSBuZXcgWmlwRm9sZGVyVmlldyhzdGF0ZS56aXBGb2xkZXJWaWV3U3RhdGUpXG4gICAgICAgIEBtb2RhbFBhbmVsID0gYXRvbS53b3Jrc3BhY2UuYWRkTW9kYWxQYW5lbChpdGVtOiBAemlwRm9sZGVyVmlldy5nZXRFbGVtZW50KCksIHZpc2libGU6IGZhbHNlKVxuXG4gICAgICAgICMgRXZlbnRzIHN1YnNjcmliZWQgdG8gaW4gYXRvbSdzIHN5c3RlbSBjYW4gYmUgZWFzaWx5IGNsZWFuZWQgdXAgd2l0aCBhIENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgICAgICAgQHN1YnNjcmlwdGlvbnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZVxuXG4gICAgICAgICMgUmVnaXN0ZXIgY29tbWFuZCB0aGF0IHJ1bnMgdGhpcyB2aWV3XG4gICAgICAgIEBzdWJzY3JpcHRpb25zLmFkZCBhdG9tLmNvbW1hbmRzLmFkZCAnYXRvbS13b3Jrc3BhY2UnLCAnemlwLWZvbGRlcjpydW4nOiA9PiBAcnVuKClcbiAgICAgICAgIyBAc3Vic2NyaXB0aW9ucy5hZGQgYXRvbS5jb21tYW5kcy5hZGQgJ2F0b20td29ya3NwYWNlJywgJ3ppcC1mb2xkZXI6dG9nZ2xlJzogPT4gQHRvZ2dsZSgpXG5cbiAgICAgIGRlYWN0aXZhdGU6IC0+XG4gICAgICAgIEBtb2RhbFBhbmVsLmRlc3Ryb3koKVxuICAgICAgICBAc3Vic2NyaXB0aW9ucy5kaXNwb3NlKClcbiAgICAgICAgQHppcEZvbGRlclZpZXcuZGVzdHJveSgpXG5cbiAgICAgIHNlcmlhbGl6ZTogLT5cbiAgICAgICAgemlwRm9sZGVyVmlld1N0YXRlOiBAemlwRm9sZGVyVmlldy5zZXJpYWxpemUoKVxuXG4gICAgICBydW46IC0+XG4gICAgICAgICMgcmVxdWlyZSBsaWJyYXJpZXMgdGhhdCB3ZSByZWx5IG9uXG4gICAgICAgIGZzID0gcmVxdWlyZSgnZnMtcGx1cycpXG4gICAgICAgIEpTWmlwID0gcmVxdWlyZShcImpzemlwXCIpXG4gICAgICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJylcblxuICAgICAgICAjIHNldCB1cCBhIG5ldyB6aXAgY2xhc3NcbiAgICAgICAgemlwID0gbmV3IEpTWmlwKClcbiAgICAgICAgIyBnZXQgdGhlIHByb2plY3QgcGF0aHMgZnJvbSBhdG9tXG4gICAgICAgIGJhc2VQYXRocyA9IGF0b20ucHJvamVjdC5nZXRQYXRocygpXG5cbiAgICAgICAgIyB0aGlzIGdldHMgdGhlIGxpc3QgdHJlZSBlbGVtZW50IG9mIHRoZSBpbnRlcmZhY2VcbiAgICAgICAgbGlzdFRyZWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudHJlZS12aWV3JylcblxuICAgICAgICAjIGdldCBhbGwgdGhlIHNlbGVjdGVkIGl0ZW1zIGluIHRoZSBsaXN0IHRyZWVcbiAgICAgICAgc2VsZWN0ZWQgPSBsaXN0VHJlZS5xdWVyeVNlbGVjdG9yQWxsKCcuc2VsZWN0ZWQgPiAuaGVhZGVyID4gc3BhbiwgLnNlbGVjdGVkID4gc3BhbicpXG5cbiAgICAgICAgIyBpZiB3ZSBhcmUgaGFuZGxpbmcgbW9yZSB0aGVuIG9uZSBpdGVtIHRoZW4gdGhlIHppcCBuYW1lIHdpbGwgYmUgdGhlIHByb2plY3RzIG1haW4gZm9sZGVyIG5hbWVcbiAgICAgICAgIyBlbHNlIHRoZSBmb2xkZXIvZmlsZSBuYW1lIGlzIHRoZSBzZWxlY3RlZCBpdGVtcyBuYW1lXG4gICAgICAgIGlmIHNlbGVjdGVkLmxlbmd0aCA+IDFcbiAgICAgICAgICAgICMgZ2V0IGFuIGFycmF5IG9mIGZvbGRlcnNcbiAgICAgICAgICAgIHBpZWNlcyA9IGJhc2VQYXRoc1swXS5zcGxpdChwYXRoLnNlcClcbiAgICAgICAgICAgICMgZ2V0IHRoZSBuYW1lIG9mIHRoZSBzZWxlY3RlZCBpdGVtIHJlcGxhY2luZyAuIHdpdGggLVxuICAgICAgICAgICAgbmFtZSA9IHBpZWNlc1twaWVjZXMubGVuZ3RoIC0gMV0ucmVwbGFjZShcIi5cIiwgXCItXCIpXG4gICAgICAgICAgICAjIHNldCB0aGUgc2F2ZSBwYXRoXG4gICAgICAgICAgICBzYXZlUGF0aCA9IGJhc2VQYXRoc1swXSArIHBhdGguc2VwICsgbmFtZSArIFwiLnppcFwiXG4gICAgICAgICAgICAjIHNldCB0aGUgc2VsZWN0ZWRCYXNlUGF0aCB0byBlbXB0eVxuICAgICAgICAgICAgc2VsZWN0ZWRCYXNlUGF0aCA9IFwiXCJcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgIyBnZXQgYW4gYXJyYXkgb2YgZm9sZGVyc1xuICAgICAgICAgICAgcGllY2VzID0gc2VsZWN0ZWRbMF0uZGF0YXNldC5wYXRoLnNwbGl0KHBhdGguc2VwKVxuICAgICAgICAgICAgIyBnZXQgdGhlIG5hbWUgb2YgdGhlIHNlbGVjdGVkIGl0ZW0gcmVwbGFjaW5nIC4gd2l0aCAtXG4gICAgICAgICAgICBuYW1lID0gcGllY2VzW3BpZWNlcy5sZW5ndGggLSAxXS5yZXBsYWNlKFwiLlwiLCBcIi1cIilcbiAgICAgICAgICAgICMgcmVtb3ZlIHRoZSBzZWxlY3RlZCBpdGVtIGZyb20gdGhlIHNhdmUgcGF0aFxuICAgICAgICAgICAgcGllY2VzLnNwbGljZShwaWVjZXMubGVuZ3RoIC0gMSwgMSlcbiAgICAgICAgICAgICMgYnVpbGQgdGhlIHRhcmdldCBwYXRoXG4gICAgICAgICAgICB0YXJnZXRQYXRoID0gcGllY2VzLmpvaW4ocGF0aC5zZXApXG4gICAgICAgICAgICAjIHNldCB0aGUgc2F2ZSBwYXRoXG4gICAgICAgICAgICBzYXZlUGF0aCA9IHRhcmdldFBhdGggKyBwYXRoLnNlcCArIG5hbWUgKyBcIi56aXBcIlxuICAgICAgICAgICAgIyBzZXQgdGhlIHNlbGVjdGVkQmFzZVBhdGggdG8gZW1wdHlcbiAgICAgICAgICAgIHNlbGVjdGVkQmFzZVBhdGggPSBcIlwiXG4gICAgICAgICAgICAjIGlmIHdlIGFyZSBoYW5kbGluZyBhIGRpcmVjdG9yeSBzZXQgdGhlIHNlbGVjdGVkQmFzZVBhdGggdG8gdGhhdFxuICAgICAgICAgICAgaWYgZnMuaXNEaXJlY3RvcnlTeW5jIHNlbGVjdGVkWzBdLmRhdGFzZXQucGF0aFxuICAgICAgICAgICAgICAgIHNlbGVjdGVkQmFzZVBhdGggPSBzZWxlY3RlZFswXS5kYXRhc2V0LnBhdGhcblxuXG4gICAgICAgICMgaWYgdGhlIHppcCBmb2xkZXIgZXhpc3RzIHRoZW4gdHJ1bmNhdGUgaXRcbiAgICAgICAgIyB0aGlzIHByZXZlbnRzIHVzIGp1c3QgYWRkaW5nIHRvIHRoZSB6aXAgZm9sZGVyXG4gICAgICAgIGlmIGZzLmV4aXN0c1N5bmMoc2F2ZVBhdGgpXG4gICAgICAgICAgICBmcy50cnVuY2F0ZVN5bmMoc2F2ZVBhdGgsIDApXG5cbiAgICAgICAgIyBjeWNsZSB0aHJvdWdoIHRoZSBzZWxlY3RlZCBsaXN0IHRyZWUgaXRlbXNcbiAgICAgICAgZCA9IDBcbiAgICAgICAgd2hpbGUgZCA8IHNlbGVjdGVkLmxlbmd0aFxuICAgICAgICAgICAgIyBnZXQgdGhlIHBhdGggb2YgdGhlIGN1cnJlbnQgaXRlbSB3ZSBhcmUgcHJvY2Vzc2luZ1xuICAgICAgICAgICAgc2VsUGF0aCA9IHNlbGVjdGVkW2RdLmRhdGFzZXQucGF0aFxuICAgICAgICAgICAgIyBzZXR1cCBhIGJsYW5rIHJlbGF0aXZlIHBhdGggdG8gdGhlIGZpbGVcbiAgICAgICAgICAgIHJlbFBhdGggPSBcIlwiXG4gICAgICAgICAgICAjIHNldHVwIGFuIGVtcHR5IGFycmF5IG9mIGZpbGVzXG4gICAgICAgICAgICBmaWxlcyA9IFtdO1xuXG4gICAgICAgICAgICAjIGlmIHRoZSBzZWxlY3RlZCBpdGVtIGlzIGEgZGlyZWN0b3J5IHRoZW5cbiAgICAgICAgICAgICMgZ2V0IGFuIGFycmF5IG9mIHRoZSBpdGVtcyBpbnNpZGUgaXQgYW5kXG4gICAgICAgICAgICAjIGFkZCB0aGF0IGFycmF5IGRpcmVjdGx5IHRvIHRoZSBmaWxlcyBhcnJheVxuICAgICAgICAgICAgaWYgZnMuaXNEaXJlY3RvcnlTeW5jKHNlbFBhdGgpXG4gICAgICAgICAgICAgICAgZmlsZXMgPSBmcy5saXN0VHJlZVN5bmMoc2VsUGF0aClcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBmaWxlcyA9IFtzZWxQYXRoXVxuXG4gICAgICAgICAgICAjIGN5Y2xlIHRocm91Z2ggdGhlIGZpbGVzIGZvdW5kXG4gICAgICAgICAgICBmaWxlQ291bnQgPSAwXG4gICAgICAgICAgICB3aGlsZSBmaWxlQ291bnQgPCBmaWxlcy5sZW5ndGhcbiAgICAgICAgICAgICAgICAjIGdldCB0aGUgYWJzb2x1dGUgcGF0aCBvZiB0aGUgY3VycmVudCBmaWxlXG4gICAgICAgICAgICAgICAgYWJzUGF0aCA9IGZpbGVzW2ZpbGVDb3VudF1cblxuICAgICAgICAgICAgICAgICMgaWYgdGhlIHNlbGVjdGVkQmFzZVBhdGggaXMgc2V0IHJlbW92ZSBpdCBmcm9tIHRoZSBhYnNvbHV0ZSBwYXRoXG4gICAgICAgICAgICAgICAgIyB0byBjcmVhdGUgdGhlIHJlbGF0aXZlIHBhdGhzIGZyb20gdGhlcmUgaW5zdGVhZCBvZiByb290XG4gICAgICAgICAgICAgICAgIyBlbHNlIHJlbW92ZSB0aGUgYmFzZSBwYXRocyBmcm9tIHRoZW1cbiAgICAgICAgICAgICAgICBpZiBzZWxlY3RlZEJhc2VQYXRoICE9IFwiXCJcbiAgICAgICAgICAgICAgICAgICAgIyByZW1lbWJlciB0byByZW1vdmUgdGhlIHRyYWlsaW5nIHNsYXNoIGVsc2UgcGF0aHMgZW5kIHVwIGFic29sdXRlIG9uIGV4dHJhY3RcbiAgICAgICAgICAgICAgICAgICAgcmVsUGF0aCA9IGFic1BhdGgucmVwbGFjZShzZWxlY3RlZEJhc2VQYXRoICsgcGF0aC5zZXAsIFwiXCIsICdpJylcbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgICMgY3ljbGUgdGhyb3VnaCB0aGUgYmFzZSBwYXRocyByZW1vdmluZyB0aGVtXG4gICAgICAgICAgICAgICAgICAgICMgZnJvbSB0aGUgYWJzb2x1dGUgcGF0aHMgdG8gY3JlYXRlIHRoZSByZWxhdGl2ZSBwYXRoXG4gICAgICAgICAgICAgICAgICAgIGJhc2VQYXRoc0NoZWNrZWQgPSAwXG4gICAgICAgICAgICAgICAgICAgIHdoaWxlIGJhc2VQYXRoc0NoZWNrZWQgPCBiYXNlUGF0aHMubGVuZ3RoXG4gICAgICAgICAgICAgICAgICAgICAgICAjIHJlbWVtYmVyIHRvIHJlbW92ZSB0aGUgdHJhaWxpbmcgc2xhc2ggZWxzZSBwYXRocyBlbmQgdXAgYWJzb2x1dGUgb24gZXh0cmFjdFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVsUGF0aCA9IGFic1BhdGgucmVwbGFjZShiYXNlUGF0aHNbYmFzZVBhdGhzQ2hlY2tlZF0gKyBwYXRoLnNlcCwgXCJcIiwgJ2knKVxuICAgICAgICAgICAgICAgICAgICAgICAgYmFzZVBhdGhzQ2hlY2tlZCsrXG5cblxuICAgICAgICAgICAgICAgICMgaWYgdGhlIGFic29sdXRlIHBhdGggaXMgbm90IGEgZGlyZWN0b3J5IHdlIGFkZCB0aGUgZmlsZSB0byB0aGUgemlwIGFyY2hpdmVcbiAgICAgICAgICAgICAgICBpZiAoIWZzLmlzRGlyZWN0b3J5U3luYyhhYnNQYXRoKSlcbiAgICAgICAgICAgICAgICAgICAgemlwLmZpbGUocmVsUGF0aCwgZnMucmVhZEZpbGVTeW5jKGFic1BhdGgpLCB7Y3JlYXRlRm9sZGVyczogdHJ1ZX0pXG5cbiAgICAgICAgICAgICAgICBmaWxlQ291bnQrK1xuXG5cbiAgICAgICAgICAgIGQrK1xuXG4gICAgICAgICMgZ2V0IHRoZSBjb21wcmVzc2lvbiBsZXZlbCBmcm9tIHRoZSBjb25maWdcbiAgICAgICAgY29tcHJlc3Npb25MZXZlbCA9IGF0b20uY29uZmlnLmdldCAnemlwLWZvbGRlci5jb21wcmVzc2lvbkxldmVsJ1xuXG4gICAgICAgICMgY2hlY2sgdGhlIGxldmVsIGlzIGEgbnVtYmVyIGFuZCB0aGF0IGl0IGlzIGJldHdlZW4gMSBhbmQgOVxuICAgICAgICAjIGVsc2UgZG9uJ3QgY29tcHJlc3MgaXQgYXQgYWxsXG4gICAgICAgIGlmIGNvbXByZXNzaW9uTGV2ZWwgPT0gcGFyc2VJbnQoY29tcHJlc3Npb25MZXZlbCwgMTApIGFuZCBjb21wcmVzc2lvbkxldmVsID4gMCBhbmQgY29tcHJlc3Npb25MZXZlbCA8IDEwXG4gICAgICAgICAgICAjIGdldCB0aGUgY29udGVudHMgb2YgdGhlIHppcCBmb2xkZXIgcmVhZHkgd2l0aCB0aGUgc2VsZWN0ZWQgY29tcHJlc3Npb25cbiAgICAgICAgICAgIGNvbnRlbnQgPSB6aXAuZ2VuZXJhdGUoe3R5cGU6XCJub2RlYnVmZmVyXCIsIGNvbXByZXNzaW9uOiBcIkRFRkxBVEVcIiwgY29tcHJlc3Npb25PcHRpb25zOiB7bGV2ZWw6IGNvbXByZXNzaW9uTGV2ZWx9fSlcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgIyBnZXQgdGhlIGNvbnRlbnRzIG9mIHRoZSB6aXAgZm9sZGVyIHdpdGggbm8gY29tcHJlc3Npb25cbiAgICAgICAgICAgIGNvbnRlbnQgPSB6aXAuZ2VuZXJhdGUoe3R5cGU6XCJub2RlYnVmZmVyXCJ9KVxuXG5cblxuXG5cbiAgICAgICAgIyB3cml0ZSB0aGUgY29udGVudHMgdG8gdGhlIHppcCBmaWxlXG4gICAgICAgIGZzLndyaXRlRmlsZShzYXZlUGF0aCwgY29udGVudCwgKGUpIC0+XG4gICAgICAgICAgICBpZiBlICE9IG51bGxcbiAgICAgICAgICAgICAgICAjIGxldCB0aGUgdXNlciBrbm93IHRoZXJlIHdhcyBhbiBlcnJvciBzYXZpbmcgdGhlIHppcCBmaWxlXG4gICAgICAgICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKGUubWVzc2FnZSlcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAjIGFsZXJ0IHRoZSB1c2VyIHdlIGFyZSBkb25lXG4gICAgICAgICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFN1Y2Nlc3MoXCJaaXAgY29tcGxldGVcIilcbiAgICAgICAgKVxuIl19
